# package

<!-- TOC -->

- [1. Prepare to Package](#1-prepare-to-package)
- [2. Adding data files to the classpath](#2-adding-data-files-to-the-classpath)
- [3. Generating documentation](#3-generating-documentation)
- [4. Patching line endings for target platforms](#4-patching-line-endings-for-target-platforms)
  - [4.1. Creating multiple versions for multiple targets](#41-creating-multiple-versions-for-multiple-targets)

<!-- /TOC -->

## 1. Prepare to Package

When preparing to distribute code, always do a clean build first. We want no relics of previous builds. Our `clean` target should clean up all the output directories:

```xml
<target name="clean" description="Deletes files generated by the build.">
    <delete dir="${build.dir}"/>
    <delete dir="${dist.dir}"/>
</target>
```

When run, the `clean` target guarantees that there’s nothing in the directories that Ant will build into. The `<javac>` task will build everything again, so the `.class` files in `build/classes` will be current. We need to accompany those files with any resources in the source tree; we do so with a `<copy>` action.

## 2. Adding data files to the classpath

Alongside the generated `.class` files, developers often need to include **data files** in the Java package hierarchy and, in so doing, copy them into the JAR. These files, which are called **resources** when they are on the **classpath**, can then be retrieved with a call to `this.getClass().getResource()` or `getResourceAsStream()`. The normal way to work with these files is to keep them all in the **source directory** and copy them into the **compiled classes directory** after compiling the Java code. 

First, we define a property containing the pattern to include:

```xml
<property name="source.files.tocopy" value="**/*.properties,**/*.dtd,**/*.xml,**/*.xsd,**/*.jpg"/>
```

We declare this as a property for ease of reuse. For the source, we add:

```xml
<copy todir="${build.classes.dir}">
    <fileset dir="src" includes="${source.files.tocopy}"/>
</copy>
```

Make sure the pattern includes all the files you want to distribute and none that you do not.

If we include **resources** with our **test classes**, we need to do the same action, albeit with a different source and destination:

```xml
<copy todir="${test.classes.dir}">
    <fileset dir="test" includes="${source.files.tocopy}"/>
</copy>
```

We normally do this copy immediately after compiling the source, right after the `<javac>` task. There’s never any situation in which we would not want to copy the resources over, so having a unified target is good.

```xml
<target name="compile" depends="init">
    <javac srcdir="${src.dir}" destdir="${build.classes.dir}">
        <include name="**/*.java"/>
    </javac>
    <copy todir="${build.classes.dir}">
        <fileset dir="${src.dir}" includes="${source.files.tocopy}"/>
    </copy>
</target>
```

After **compiling the code** we need to generate the **JavaDoc HTML files** that both the source and binary distribution packages can redistribute.

## 3. Generating documentation

To create the JavaDoc files, we turn to the `<javadoc>` task, which offers complete access to the javadoc program. Its basic use is quite straightforward. As usual, we have to declare and create a destination directory in our `init` target:

```xml
<property name="dist.dir" location="dist"/>
<property name="dist.doc.dir" location="${dist.dir}/doc"/>

<target name="init">
    <mkdir dir="${build.classes.dir}"/>
    <mkdir dir="${dist.doc.dir}"/>
</target>
```

Then we declare a new target to create the documentation.

```xml
<target name="javadocs" depends="compile" description="make the java docs" >
    <javadoc
            access="private"
            sourcepath="${src.dir}"
            destdir="${dist.doc.dir}"
            packagenames="d1.*"
            use="true"
            version="true"
            windowtitle="${ant.project.name}"
            failonerror="true">
        <classpath refid="compile.classpath"/>
    </javadoc>
</target>
```

## 4. Patching line endings for target platforms

Shell scripts and plain text documentation have one extra need: their lines must end with the appropriate line endings for the target platform. Files intended for use on Windows should have `\r\n` line endings; Unix files need `\n` terminators.

The task for adjusting line endings is `<fixcrlf>`; this task can be set to convert to the Unix (`\n`), MSDOS (`\r\n`), or Mac OS (`\r`) line endings, depending on the setting of the `eol` option. If that option is not set, the task defaults to setting the line ending of the local system.

```xml
<property name="unix.scripts" value="**/*.sh,**/*.pl,**/*.py" />
<property name="dos.scripts" value="**/*.bat,**/*.cmd" />
```

These patterns are used in our "scripts" target, which does **three things**. It copies the files into the distribution directory, patches the name of the JAR file we are creating, and then fixes the line endings before finally making the Unix files executable:

```xml
<target name="scripts" depends="init">
    <copy todir="${dist.dir}" overwrite="true">
        <fileset dir="bin" includes="${unix.scripts},${dos.scripts}"/>
        <filterset begintoken="[[" endtoken ="]]">
            <filter token="TARGET.NAME" value="${target.name}"/>
        </filterset>
    </copy>

    <fixcrlf srcdir="${dist.dir}" eol="unix" includes="${unix.scripts}" />
    <fixcrlf srcdir="${dist.dir}" eol="dos" includes="${dos.scripts}" />

    <chmod dir="${dist.dir}" perm="a+x" includes="${unix.scripts}" />
</target>
```

The `<fixcrlf>` task overwrites the destination files if the existing line endings don’t match those in the `eol` attribute. If the file is already patched, `<fixcrlf>` does
nothing. Unless you specify a directory in the `destdir` attribute, this will mean it overwrites the original files.

Now, what if we want to create text files and scripts for both Windows and Unix?

### 4.1. Creating multiple versions for multiple targets

If you create distributions with scripts and text files that are targeted at multiple operating systems, you may need to create multiple copies of the relevant files, each with the correct line endings in the target.

```xml
<target name="fix-docs" depends="dist-docs,javadocs">
    <property name="readme.windows.file" location="${dist.doc.dir}/readme.txt" />
    <property name="readme.unix.file" location="${dist.doc.dir}/README" />

    <copy file="${readme.windows.file}" tofile="${readme.unix.file}"/>

    <fixcrlf eol="crlf" file="${readme.windows.file}" tab="remove" tablength="4" />
    <fixcrlf eol="lf" file="${readme.unix.file}" tab="remove" tablength="2" />
</target>
```





